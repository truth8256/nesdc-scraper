# NESDC Scraper 진행 상황 기록

**최종 수정**: 2026-02-21 20:40

---

## 🎯 기본 방향

- **메인 파서**: pdfplumber (빠르고 안정적)
- **세컨 파서**: Docling (개선 필요, 정확도 확보 시 사용)
  - 현재 다른 컴퓨터에서는 정상 작동 확인
  - 현재 환경에서 타임아웃 발생 (원인 조사 필요)

---

## 📊 Phase 2 완료 사항

### 1. 페이지 자동 탐지 시스템 (✅ 완료)

#### find_target_pages_v2.py
- **성공률**: 75% (15/20 폴더)
- **정확도**: 86.7% (13/15 폴더)

**주요 개선사항**:
1. 페이지 인덱스 기반 검색 (page_index.csv)
2. 키워드 조건: "정당" 포함
3. 페이지 조건: 3페이지 이상 (요약/목차 제외)
4. 표 지표: "사례수", "조사완료", "가중값" 포함
5. 페이지 개수 제한 제거 (유효성 검사가 필터링)

**검색 결과**:
```
✅ 찾은 폴더 (15개):
15300 [6, 7]       15302 [10]         15303 [8]
15304 [5, 6]       15305 [4,11,13,15] 15308 [11, 12]
15309 [11, 12]     15310 [11, 12]     15311 [19, 20]
15312 [25, 26]     15315 [4]          15317 [5]
15319 [4, 8]       15321 [15, 16]     15322 [15]

❌ 못 찾은 폴더 (5개):
15306, 15307 - PDF 인코딩 오류
15314, 15316 - 정당지지도 항목 없음 (교육감/시장 선거)
15320 - 인코딩 오류
```

---

### 2. 개선된 페이지 인덱싱 (✅ 완료)

#### summarize_pdf_pages.py
**인코딩 오류 감지 기능 추가**:
- 텍스트 추출 실패 시 명확한 영어 메시지 삽입
- `[ENCODING_ERROR] Text extraction failed due to encoding issues`
- 인코딩 오류 자동 감지 로직 구현

**결과**:
- 411 페이지 인덱싱 완료 (18/20 폴더)
- CSV 검색 가능 (Ctrl+F)

---

### 3. 파서 비교 시스템 (✅ 개발 완료, 🔄 테스트 진행 중)

#### compare_parsers_v2.py (신규 개발)

**새로운 기능**:
1. ✅ 체크포인트 기반 재개 (`--resume`)
2. ✅ 개별 파서 선택 (`--parser pdfplumber` 또는 `--parser docling`)
3. ✅ 특정 폴더 선택 (`--folders 15308 15309`)
4. ✅ 실행 시간 측정 및 표시
5. ✅ 진행 상황 자동 저장
6. ✅ find_target_pages_v2 통합 (정확한 페이지 사용)

**사용 예시**:
```bash
# 단일 폴더 테스트
python compare_parsers_v2.py --folders 15308

# pdfplumber만 전체 실행 (권장)
python compare_parsers_v2.py --parser pdfplumber

# 재개 (중단 시)
python compare_parsers_v2.py --resume

# 전체 비교
python compare_parsers_v2.py
```

**초기 테스트 결과** (15308):
| 파서 | 결과 | 테이블 수 | 실행 시간 |
|------|------|-----------|-----------|
| pdfplumber | ✅ 성공 | 2개 | 21.6초 |
| Docling | ❌ 타임아웃 | 0개 | 192.4초 (120초 제한 초과) |

---

### 4. 구버전 비교 테스트 결과 (중단됨)

**완료된 폴더**: 15300~15311 (11개 폴더)

**실제 데이터 추출 성공**:
- 15308: pdfplumber=2, docling=1
- 15309: pdfplumber=2, docling=1
- 15310: pdfplumber=2, docling=1
- 15311: pdfplumber=2
- 15304: docling=1

**문제점**:
- 구버전 find_target_pages 사용 → 잘못된 페이지 파싱
- Docling 타임아웃 빈번 (현재 환경 문제 가능성)
- 검증 함수 오류 (이미 수정됨)

---

## 🔧 기술적 개선사항

### 1. 인코딩 처리
- UTF-8 일관성 확보
- 인코딩 오류 자동 감지 및 메시지 삽입
- 콘솔 출력 인코딩 문제 해결

### 2. 검색 로직 최적화
- 키워드: "정당" → "정당지지도" 페이지 탐지
- 표 지표: "사례수", "조사완료", "가중값" → 실제 데이터 테이블 확인
- 페이지 범위: 3페이지 이상 → 요약/목차 제외

### 3. 재개 기능
- JSON 체크포인트 시스템
- 폴더별 진행 상황 저장
- 부분 완료 지원 (파서별)

---

## 📁 주요 파일

### 핵심 스크립트
```
summarize_pdf_pages.py       - PDF 페이지 인덱싱 (인코딩 감지 기능 추가)
find_target_pages_v2.py       - 정당지지도 페이지 자동 탐지 (v2 최종)
compare_parsers_v2.py         - 파서 비교 (체크포인트, 재개, 시간 측정)
pdfplumber_table_parser.py    - pdfplumber 기반 파서
table_parser.py               - Docling 기반 파서
schema.py                     - 표준 스키마 및 검증
```

### 데이터 파일
```
page_index.csv                        - 411 페이지 인덱스
parser_comparison_checkpoint.json     - 비교 테스트 체크포인트
parser_comparison_results.json        - 비교 테스트 최종 결과
data/parsed_tables/*.json             - 파싱 결과 (표준 스키마)
```

### 문서
```
WORKFLOW_SUMMARY.md           - 전체 워크플로우 평가
PROGRESS_RECORD.md            - 현재 진행 상황 (이 파일)
implementation_plan.md        - 실행 계획
```

---

## 🚀 다음 단계

### 우선순위 1: pdfplumber 전체 테스트
```bash
python compare_parsers_v2.py --parser pdfplumber
```
- 예상 시간: 5-10분
- 15개 폴더 전체 파싱 성공률 확인
- 데이터 품질 검증

### 우선순위 2: Docling 환경 조사
- 현재 환경에서 타임아웃 원인 분석
- 다른 컴퓨터 환경과 비교
- 모델 로딩, 메모리, GPU 사용 등 확인

### 우선순위 3: 실패 케이스 분석
- 15300, 15302, 15303, 15304, 15305 실패 원인
- 페이지 범위 확장 필요성 검토
- 대체 파서 옵션 (camelot, tabula 등)

---

## 📈 성능 지표

### 전체 파이프라인
```
1. 페이지 인덱싱    → 90% 성공 (18/20)
2. 페이지 자동 탐지  → 75% 성공 (15/20)
3. 파싱 실행        → 테스트 중
4. 유효성 검증      → 스키마 준비 완료
```

### 목표
- pdfplumber 성공률: 60% 이상 (현재 예상 53.8% 기준)
- Docling 보완: 정확도 우선, 속도는 차순위
- 전체 커버리지: 수동 매핑 포함 100%

---

## 💡 핵심 인사이트

1. **페이지 인덱스 방식이 효과적**
   - 구 page_finder_v2 (20%) → find_target_pages_v2 (75%)
   - 3배 이상 성능 향상

2. **표 지표 키워드가 중요**
   - "사례수", "조사완료", "가중값" 추가로 정확도 향상
   - False positive 감소

3. **pdfplumber가 안정적**
   - 빠른 실행 시간 (~20초/폴더)
   - 일관된 결과
   - 메인 파서로 적합

4. **Docling은 환경 의존적**
   - 다른 환경에서 성공 경험 있음
   - 현재 환경에서 타임아웃 발생
   - 추가 조사 및 최적화 필요

---

**작성일**: 2026-02-21 20:40
**다음 세션 시작점**: pdfplumber 전체 테스트 실행
